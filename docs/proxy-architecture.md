# Архитектура HTTP-прокси для Copilot Chat

## Обзор

HTTP-прокси для Copilot Chat предназначен для перехвата запросов в режиме Agent и их обработки через Orchestrator Core. Прокси запускается автоматически вместе с VS Code и перезапускается в случае сбоев.

## Компоненты

### ProxyManager

Класс `ProxyManager` отвечает за управление жизненным циклом прокси-сервера:
- Запуск и остановка прокси-сервера
- Поиск свободного порта в диапазоне 7001-7010
- Проверка доступности прокси
- Автоматический перезапуск в случае сбоев
- Периодическая проверка работоспособности (каждые 30 секунд)

### Прокси-сервер

Прокси-сервер реализован с использованием Express и обрабатывает следующие запросы:
- `GET /ping` - проверка работоспособности
- `POST /v1/chat/completions` - обработка запросов чата
- Все остальные запросы проксируются на OpenAI API

### OrchestratorAdapter

Адаптер для взаимодействия с Orchestrator Core:
- `processPrompt` - обработка входящих сообщений
- `processResponse` - обработка ответов от OpenAI API
- Логирование запросов и ответов в формате JSON Lines

## Схема работы

1. При запуске VS Code активируется расширение
2. Запускается Orchestrator Core
3. Запускается прокси-сервер на свободном порту из диапазона 7001-7010
4. Проверяется наличие переменной окружения `GH_COPILOT_OVERRIDE_PROXY_URL`
5. Copilot Chat отправляет запросы через прокси
6. Прокси обрабатывает запросы через Orchestrator Core
7. Ответы логируются и возвращаются клиенту

## Логирование

Логи сохраняются в формате JSON Lines в директории `~/.orchestrator/logs/` с именем файла в формате `YYYY-MM-DD.log`. Каждая запись содержит:
- `ts` - временная метка в формате ISO
- `phase` - фаза (inbound/outbound)
- `data` - данные запроса или ответа

## Требования к среде

- Node.js 18 LTS
- Express 4
- Undici
- eventsource-parser

## Переменные окружения

- `GH_COPILOT_OVERRIDE_PROXY_URL` - URL прокси-сервера (обязательная)
- `PORT` - порт для прокси-сервера (опциональная, по умолчанию используется первый свободный порт из диапазона 7001-7010)
